<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Norsk Nyhetskanal - Azure Static Web App</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- Meta tags -->
    <meta name="description" content="Azure Static Web App broadcast system med Dataverse integrasjon">
    <meta name="keywords" content="azure, static web app, broadcast, nyheter, dataverse, microsoft">
    <meta name="author" content="Azure Broadcast System">
    <meta name="theme-color" content="#1e3c72">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Norsk TV - Azure Broadcast System">
    <meta property="og:description" content="Professional broadcast system powered by Azure Static Web Apps">
    <meta property="og:type" content="website">
    
    <!-- Favicon -->
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/css/styles.css" as="style">
    <link rel="modulepreload" href="/js/main.js" as="script">
    <link rel="preconnect" href="https://alcdn.msauth.net">
    <link rel="preconnect" href="https://login.microsoftonline.com">
    <link rel="preconnect" href="https://beredskap360utv.api.crm4.dynamics.com">
    
    <!-- Security headers via meta tags -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Initial loader styles -->
    <style>
        .initial-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        .loader-content {
            text-align: center;
            color: white;
        }
        
        .loader-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loader-text {
            font-size: 1.5rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        .loader-status {
            margin-top: 20px;
            font-size: 1rem;
            opacity: 0.8;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="initialLoader" class="initial-loader">
        <div class="loader-content">
            <div class="loader-logo">üì∫</div>
            <div class="loader-text">Azure Static Web App</div>
            <div class="loader-spinner"></div>
            <div class="loader-status" id="loaderStatus">Starter applikasjon...</div>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">üì∫ NORSK TV</div>
            <h3>Azure Static Web App Edition</h3>
            <p style="margin: 20px 0; color: #666;">
                Logg inn med Microsoft-kontoen din for √• f√• tilgang til sendestudiet
            </p>
            
            <button class="login-btn" id="loginBtn" aria-label="Logg inn med Microsoft">
                üîê Logg inn med Microsoft
            </button>
            
            <div class="loading" id="loginLoading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Logger inn...</p>
            </div>
            
            <div class="error-message" id="loginError" role="alert"></div>
            <div class="success-message" id="loginSuccess" role="status"></div>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 0.9rem; color: #666;">
                <strong>Azure Static Web App</strong><br>
                Version: 1.0.0 | Environment: Production<br>
                Deployment: Automatic via GitHub Actions<br>
                <small>Client ID: e7174676-e8bb-446b-9260-af3f28086458</small>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-container" id="mainContainer">
        <header class="header-bar" role="banner">
            <div>
                <strong>üì∫ Norsk TV - Azure Static Web App</strong>
                <span style="margin-left: 20px; opacity: 0.8;">
                    Powered by Microsoft Dataverse
                </span>
            </div>
            <div class="user-info">
                <span style="font-size: 0.9rem; opacity: 0.8;">Bruker:</span>
                <span id="userDisplayName">Laster...</span>
                <button class="logout-btn" id="logoutBtn" aria-label="Logg ut">Logg ut</button>
            </div>
        </header>

        <div class="time-display" id="currentTime" role="timer" aria-live="polite"></div>
        
        <div class="live-countdown" id="liveCountdown" role="timer" aria-live="polite">
            <div><strong>üî¥ NESTE SENDING</strong></div>
            <div class="countdown-number" id="liveCountdownNumber">--</div>
            <div id="liveCountdownText">sekunder</div>
        </div>
        
        <main class="background-screen" id="backgroundScreen" role="main">
            <div class="logo-container">
                <h1 class="logo">NORSK TV</h1>
                <div class="tagline">Azure Static Web App Broadcasting</div>
                <div class="version-info">Powered by Microsoft Cloud Platform</div>
            </div>
        </main>

        <aside class="schedule-info" id="scheduleInfo" role="complementary" aria-label="Sendeskjema">
            <strong>üì∫ Sendeskjema fra Dataverse:</strong><br>
            <div id="scheduleList">
                <div class="loading-spinner"></div>
                <span>Laster sendeskjema fra Microsoft Dataverse...</span>
            </div>
        </aside>

        <section class="video-container" id="videoContainer" role="main" aria-label="Video avspilling">
            <div class="video-content">
                <video 
                    id="realVideo" crossorigin="anonymous" 
                    style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" 
                    muted 
                    autoplay 
                    playsinline
                    loop="false"
                    preload="metadata"
                    disablepictureinpicture
                    controlslist="nodownload nofullscreen noremoteplayback"
                    aria-label="Program video">
                </video>
                <div class="animated-program" id="animatedProgram" style="display: none;" role="img" aria-label="Program animasjon">
                    <!-- Fallback animasjon -->
                </div>
                <div class="video-overlay" id="videoOverlay">
                    <div id="currentProgramTitle">Program p√•g√•r...</div>
                    <div class="program-source">üì° Azure Static Web App</div>
                </div>
                <div class="video-progress" role="progressbar" aria-label="Program fremdrift">
                    <div class="video-progress-bar" id="progressBar"></div>
                </div>
            </div>
        </section>

        <footer class="news-banner" role="contentinfo">
            <div class="news-ticker">
                <div class="news-text" id="newsText" aria-live="polite" aria-label="Nyhets-ticker">
                    Kobler til Microsoft Dataverse via Azure Static Web App...
                </div>
            </div>
        </footer>

        <div class="status-panel" role="status" aria-live="polite">
            <div class="dataverse-status" id="dataverseStatus">
                üîó Dataverse: Initialiserer...
            </div>
            <div class="deployment-info">
                üåê Azure Static Web App | üöÄ Global CDN | üîí Auto HTTPS
            </div>
        </div>
    </div>

    <!-- MSAL.js with working CDN URLs -->
    <script>
        console.log('üìÑ Loading MSAL.js library...');
        document.getElementById('loaderStatus').textContent = 'Laster autentisering...';
        
        (function() {
            const msalUrls = [
                '/vendor/msal/msal-browser.min.js', // local fallback (place file here)
                'https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js',
                'https://alcdn.msftauth.net/browser/2.35.0/js/msal-browser.min.js',
                'https://cdn.jsdelivr.net/npm/@azure/msal-browser@3.24.0/lib/msal-browser.min.js'
            ];
            
            let currentUrl = 0;
            
            function loadMsal() {
                if (currentUrl >= msalUrls.length) {
                    console.error('‚ùå Failed to load MSAL from all CDNs');
                    document.getElementById('loaderStatus').textContent = 'Feil ved lasting av autentisering';
                    setTimeout(() => {
                        document.getElementById('loginError').textContent = 'Kunne ikke laste autentiseringsbibliotek. Sjekk internettforbindelsen og pr√∏v igjen.';
                        hideInitialLoader();
                    }, 2000);
                    return;
                }
                
                // Removed dynamic script injection - using static module import
            }
            
            loadMsal();
        })();
        
        // Load main app script
        function loadAppScript() {
            // Removed dynamic script injection - using static module import
        }
    </script>

    <!-- Application Initialization -->
    <script>
        // Performance monitoring
        const perfStart = performance.now();
        
        // Hide initial loader
        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                }, 300);
            }
        }

        // --- wait for MSAL UMD global ---
        function waitForMsal(timeout = 15000) {
            return new Promise((resolve, reject) => {
                const start = Date.now();
                (function check() {
                    if (typeof window.msal !== 'undefined') { resolve(window.msal); return; }
                    if (Date.now() - start > timeout) { reject(new Error('MSAL not loaded')); return; }
                    setTimeout(check, 100);
                })();
            });
        }

        // --- initialize app (async) ---
        async function initializeApp() {
            try {
                const msalGlobal = await waitForMsal();
                const { PublicClientApplication } = msalGlobal;
                const msalInstance = new PublicClientApplication(window.msalConfig || msalConfig);
                window.msalInstance = msalInstance;

                const mod = await import('/js/main.js');
                if (mod && typeof mod.boot === 'function') {
                    await mod.boot(msalInstance);
                } else {
                    console.warn('main.js did not export boot(msalInstance)');
                }

                console.log('‚úÖ Application initialized with MSAL');
                hideInitialLoader();
            } catch (error) {
                console.error('‚ùå Failed to initialize application:', error);
                const el = document.getElementById('loginError');
                if (el) {
                    el.textContent = 'Kunne ikke starte applikasjon: ' + (error.message || 'Ukjent feil');
                    el.style.display = 'block';
                }
                hideInitialLoader();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM loaded, checking script dependencies...');
            
            // Check if scripts are already loaded
            if (typeof AzureBroadcastApp !== 'undefined' && typeof msal !== 'undefined') {
                initializeApp();
            } else {
                // Wait for scripts to load
                let attempts = 0;
                const maxAttempts = 20; // Increased attempts
                
                const checkScripts = setInterval(() => {
                    attempts++;
                    console.log(`üîç Checking dependencies... attempt ${attempts}/${maxAttempts}`);
                    
                    if (typeof AzureBroadcastApp !== 'undefined' && typeof msal !== 'undefined') {
                        clearInterval(checkScripts);
                        initializeApp();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkScripts);
                        console.error('‚ùå Dependencies failed to load after maximum attempts');
                        
                        let missingDeps = [];
                        if (typeof msal === 'undefined') missingDeps.push('MSAL.js');
                        if (typeof AzureBroadcastApp === 'undefined') missingDeps.push('App.js');
                        
                        document.getElementById('loginError').textContent = 
                            `Kunne ikke laste: ${missingDeps.join(', ')}. Sjekk internettforbindelsen og pr√∏v igjen.`;
                        hideInitialLoader();
                    }
                }, 500);
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (window.broadcastApp && !document.hidden) {
                console.log('üëÅÔ∏è Page focused - refreshing data');
                if (typeof window.broadcastApp.refreshData === 'function') {
                    window.broadcastApp.refreshData();
                }
            }
        });

        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('üö® Global JavaScript error:', e.error);
            if (window.broadcastApp && typeof window.broadcastApp.handleGlobalError === 'function') {
                window.broadcastApp.handleGlobalError(e.error);
            } else {
                // Fallback error handling
                const errorEl = document.getElementById('loginError');
                if (errorEl && !errorEl.textContent) {
                    errorEl.textContent = 'En feil oppstod: ' + (e.error?.message || 'Ukjent feil');
                    errorEl.style.display = 'block';
                }
            }
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('üö® Unhandled promise rejection:', e.reason);
            if (window.broadcastApp && typeof window.broadcastApp.handleGlobalError === 'function') {
                window.broadcastApp.handleGlobalError(e.reason);
            }
            e.preventDefault();
        });

        // Performance logging
        window.addEventListener('load', function() {
            const loadTime = performance.now() - perfStart;
            console.log(`üìä Total initialization time: ${Math.round(loadTime)}ms`);
            
            // Log performance metrics
            if (window.performance && window.performance.timing) {
                const timing = window.performance.timing;
                const totalLoadTime = timing.loadEventEnd - timing.navigationStart;
                const domReadyTime = timing.domContentLoadedEventEnd - timing.navigationStart;
                
                console.log(`üìä Page load: ${totalLoadTime}ms`);
                console.log(`üìä DOM ready: ${domReadyTime}ms`);
            }
        });

        // Network status monitoring
        window.addEventListener('online', function() {
            console.log('üåê Network: Online');
            if (window.broadcastApp && typeof window.broadcastApp.handleNetworkOnline === 'function') {
                window.broadcastApp.handleNetworkOnline();
            }
        });

        window.addEventListener('offline', function() {
            console.log('üåê Network: Offline');
            if (window.broadcastApp && typeof window.broadcastApp.handleNetworkOffline === 'function') {
                window.broadcastApp.handleNetworkOffline();
            }
        });

        // Service worker registration (PWA support)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('‚ÑπÔ∏è Service Worker registration failed:', error);
                    });
            });
        }

        // Console deployment info
        console.log('%cüéØ Azure Static Web App Deployment Info', 'color: #0078d4; font-weight: bold; font-size: 14px;');
        console.log('   Hosting: Azure Static Web Apps');
        console.log('   CDN: Azure Global Network');
        console.log('   SSL: Automatic (Let\'s Encrypt)');
        console.log('   Deployment: GitHub Actions');
        console.log('   Build Time:', new Date().toISOString());
        console.log('   Client ID: e7174676-e8bb-446b-9260-af3f28086458');
    </script>
  
</body>
</html>
